# MicroShift with OpenTelemetry Tracing enabled

Follow the steps below to view OpenTelemetry trace data from MicroShift
Jaeger frontend can be viewed at `http://localhost:16686/`
The following trace services can be viewed:

```
kube-apiserver
etcd
crio
```

Then, deploy an example application instrumented to export OpenTelemetry trace spans.
This application is a simple web server, service, and route.
The trace service `test-service` will be added and can be viewed in the Jaeger UI.

```bash
oc create ns otel-dev
oc apply -f https://raw.githubusercontent.com/sallyom/golang-ex/master/opentelemetry-sample-app/sample-app-microshift.yaml
oc get routes -n otel-dev
```
Trace data will be generated by reloading a counter page at `https://localhost:8080/count`

## Install, start, and configure CRI-O to emit OpenTelemetry trace data

#### Fedora >= 36

```sh
sudo dnf module enable -y cri-o:1.23
sudo dnf install -y cri-o cri-tools
sudo systemctl start crio
```
### Configure CRI-O to export OpenTelemetry spans

Turn on cri-o with tracing by adding a crio.conf.d file

```shell
sudo su
mkdir /etc/crio/crio.conf.d
cat <<EOF > /etc/crio/crio.conf.d/otel.conf
[crio.tracing]
tracing_sampling_rate_per_million=999999
enable_tracing=true
EOF

systemctl daemon-reload
systemctl start crio
exit
```

### Install MicroShift rpm and Replace MicroShift binary with OpenTelemetry instrumented binary

#### Extract MicroShift-OpenTelemetry scripts

```bash
  sudo podman run --rm -d --name microshift-scripts quay.io/sallyom/microshift:otel-bin sleep 30
  sudo podman cp microshift-scripts:/opt/otelcol-jaeger-microshift.sh otelcol-jaeger-microshift.sh
  sudo chown $(id -u):$(id -u) otelcol-jaeger-microshift.sh
  sudo podman stop microshift-scripts
```

#### Launch

To launch MicroShift with OpenTelemetryCollector and Jaeger, run 

```bash
./otelcol-jaeger-microshift.sh run
```

The `otelcol-jaeger-microshift.sh run` script does the following:

- enables community MicroShift rpm from `redhat-et/microshift` copr repository
- installs MicroShift rpm
- extracts instrumented MicroShift binary from `quay.io/sallyom/microshift:otel-bin`
- replaces local `/usr/bin/microshift` with extracted binary
- download OpenTelemetry Collector rpm
- places OpenTelemetry Collector config at /etc/otelcol/config.yaml
- starts local OpenTelemetry Collector systemd service `otelcol`
- starts `Jaeger All-In-One` running as a pod on local host
- downloads OpenShift client `oc` and K8s client `kubectl`
- starts MicroShift systemd service with the instrumented MicroShift binary
    - kube-apiserver exports trace spans
    - etcd exports trace spans
- copies cluster kubeconfig file to default non-root location `~/.kube/config`

#### Cleanup

To cleanup and remove all artifacts, run 

```bash
./otelcol-jaeger-microshift.sh cleanup
```

The `otelcol-jaeger-microshift.sh cleanup` script does the following:

- rm -rf ~/.kube/config openshift-client-linux.tar.gz
- stops/removes jaeger pod
- stops systemd otelcol service
- removes opentelemetry collector package `otelcol`
- stops and disables systemd microshift service
- stops and removes all CRIO-O containers
- removes CRI-O images
- pkill -9 conmon
- pkill -9 pause
